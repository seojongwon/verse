@page "/group/{GroupId:guid}/verses"
@using RetreatVerses.App.Data
@inject IDataStore DataStore

<h3>조별 말씀 목록</h3>

@if (!string.IsNullOrWhiteSpace(actionMessage))
{
    <div class="alert @(actionSuccess ? "alert-success" : "alert-danger")">@actionMessage</div>
}

@if (group == null)
{
    <p class="text-muted">조 정보를 찾을 수 없습니다.</p>
}
else
{
    <p><strong>@group.Name</strong> 조의 등록된 말씀입니다.</p>
    <p>
        <a class="btn btn-outline-primary" href="/use">말씀 사용하기</a>
    </p>

    @if (items.Count == 0)
    {
        <p class="text-muted">등록된 말씀이 없습니다.</p>
    }
    else
    {
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th>말씀</th>
                    <th class="table-nowrap">유형</th>
                    <th class="table-nowrap">등록 시간</th>
                    <th class="table-nowrap">사용 상태</th>
                    <th class="table-nowrap">작업</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in items)
                {
                    <tr>
                        <td>@item.Text</td>
                        <td class="table-nowrap">@item.Type</td>
                        <td class="table-nowrap">@item.RegisteredAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                        <td>
                            @if (item.UsedAt.HasValue)
                            {
                                <span class="text-muted table-nowrap">사용됨 (@item.UsedAt.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm"))</span>
                            }
                            else if (item.RecitedAt.HasValue)
                            {
                                <span class="text-warning table-nowrap">암송됨 (@item.RecitedAt.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm"))</span>
                            }
                            else
                            {
                                <span class="text-success table-nowrap">사용 가능</span>
                            }
                        </td>
                        <td class="table-nowrap">
                            @if (item.UsedAt.HasValue || item.RecitedAt.HasValue)
                            {
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => ResetStatusAsync(item)">되돌리기</button>
                            }
                            <button class="btn btn-sm btn-outline-danger ms-2" @onclick="() => UnregisterAsync(item)">미등록처리</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    [Parameter] public Guid GroupId { get; set; }

    private Group? group;
    private List<VerseStatus> items = new List<VerseStatus>();
    private string? actionMessage;
    private bool actionSuccess;

    protected override async Task OnInitializedAsync()
    {
        var groups = await DataStore.GetGroupsAsync();
        group = groups.FirstOrDefault(g => g.Id == GroupId);
        if (group == null)
        {
            return;
        }

        var verses = await DataStore.GetVersesAsync();
        var verseMap = verses.ToDictionary(v => v.Id, v => v);
        var registrations = await DataStore.GetRegistrationsForGroupAsync(GroupId);

        items = registrations
            .Where(r => verseMap.ContainsKey(r.VerseId))
            .Select(r =>
            {
                var verse = verseMap[r.VerseId];
                return new VerseStatus
                {
                    Text = verse.Text,
                    Type = verse.Type,
                    RegisteredAt = r.RegisteredAt,
                    UsedAt = r.UsedAt,
                    RecitedAt = r.RecitedAt,
                    VerseId = verse.Id
                };
            })
            .OrderByDescending(i => i.RegisteredAt)
            .ToList();
    }

    private async Task ResetStatusAsync(VerseStatus item)
    {
        await DataStore.ResetVerseStatusAsync(GroupId, item.VerseId);
        await OnInitializedAsync();
    }

    private async Task UnregisterAsync(VerseStatus item)
    {
        var result = await DataStore.UnregisterVerseAsync(GroupId, item.VerseId);
        actionMessage = result.Message;
        actionSuccess = result.Success;
        await OnInitializedAsync();
    }

    private sealed class VerseStatus
    {
        public Guid VerseId { get; set; }
        public string Text { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public DateTime RegisteredAt { get; set; }
        public DateTime? UsedAt { get; set; }
        public DateTime? RecitedAt { get; set; }
    }

}
