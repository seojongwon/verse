@page "/admin/qr"
@attribute [Authorize]
@using RetreatVerses.App.Data
@inject IDataStore DataStore
@inject NavigationManager NavigationManager

<h3>QR 링크 생성</h3>

<p class="text-muted">말씀을 선택하면 QR에 넣을 링크가 생성됩니다.</p>

<div class="row g-3">
    <div class="col-md-8">
        <label class="form-label">말씀 선택</label>
        <select class="form-select" @bind="SelectedVerseId">
            <option value="">말씀을 선택하세요</option>
            @foreach (var verse in verses)
            {
                <option value="@verse.Id">@verse.Text (@verse.Type)</option>
            }
        </select>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(qrUrl))
{
    <div class="mt-4">
        <label class="form-label">QR 등록 링크</label>
        <input class="form-control" readonly value="@qrUrl" />
        <small class="text-muted">QR 코드로 바로 접속할 수 있습니다.</small>
    </div>
}

@if (!string.IsNullOrWhiteSpace(qrCodeDataUrl))
{
    <div class="mt-3 d-flex flex-wrap gap-3 align-items-start">
        <div class="p-2 border rounded bg-light">
            <img src="@qrCodeDataUrl" alt="말씀 등록 QR 코드" style="max-width: 200px; height: auto;" />
        </div>
        <div class="d-flex flex-column gap-2">
            <a class="btn btn-outline-primary" href="@qrCodeDataUrl" download="@qrFileName">QR 다운로드</a>
        </div>
    </div>
}

@code {
    private List<Verse> verses = new List<Verse>();

    private string? selectedVerseId;
    private string? qrUrl;
    private string? qrCodeDataUrl;
    private string qrFileName = "qr-code.png";

    protected override async Task OnInitializedAsync()
    {
        verses = (await DataStore.GetVersesAsync()).ToList();
    }

    private string? SelectedVerseId
    {
        get => selectedVerseId;
        set
        {
            selectedVerseId = value;
            BuildQrAssets();
        }
    }

    private void BuildQrAssets()
    {
        qrUrl = BuildQrUrl();
        if (string.IsNullOrWhiteSpace(qrUrl))
        {
            qrCodeDataUrl = null;
            return;
        }

        using var generator = new QRCoder.QRCodeGenerator();
        using var data = generator.CreateQrCode(qrUrl, QRCoder.QRCodeGenerator.ECCLevel.Q);
        var png = new QRCoder.PngByteQRCode(data);
        var bytes = png.GetGraphic(20);
        qrCodeDataUrl = $"data:image/png;base64,{Convert.ToBase64String(bytes)}";
        qrFileName = $"qr-{selectedVerseId}.png";
    }

    private string? BuildQrUrl()
    {
        if (string.IsNullOrWhiteSpace(selectedVerseId))
        {
            return null;
        }

        var baseUri = NavigationManager.BaseUri.TrimEnd('/');
        return $"{baseUri}/qr/{selectedVerseId}";
    }
}
