@page "/admin/verses"
@attribute [Authorize]
@using System.IO
@using Microsoft.AspNetCore.Hosting
@using System.Text.Json
@using RetreatVerses.App.Data
@inject IDataStore DataStore
@inject IWebHostEnvironment WebHostEnvironment

<h3>말씀 관리</h3>

<div class="mb-3">
    <label class="form-label">새 말씀</label>
    <div class="mt-2 mb-3">
        <div class="d-flex align-items-center gap-2">
            <label class="form-label mb-0">성경 검색</label>
            <select class="form-select form-select-sm w-auto" @bind="BibleBookOrder">
                <option value="json">성경순</option>
                <option value="alpha">가나다순</option>
            </select>
        </div>
        <div class="row g-3 align-items-center">
            <div class="col-12 col-md-3">
                <div class="d-flex align-items-center gap-2">
                    <span class="form-label small mb-0 me-1">성경 이름</span>
                    <select class="form-select flex-grow-1 ms-2" @bind="BibleBook">
                        @foreach (var book in bibleBooks)
                        {
                            <option value="@book">@book</option>
                        }
                    </select>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div class="d-flex align-items-center gap-2">
                    <span class="form-label small mb-0 me-1">장</span>
                    <select class="form-select flex-grow-1 ms-2" @bind="BibleChapter">
                        @foreach (var chapter in bibleChapterOptions)
                        {
                            <option value="@chapter">@chapter</option>
                        }
                    </select>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div class="d-flex align-items-center gap-2">
                    <span class="form-label small mb-0 me-1">절</span>
                    <select class="form-select flex-grow-1 ms-2" @bind="BibleVerse">
                        @foreach (var verse in bibleVerseOptions)
                        {
                            <option value="@verse">@verse</option>
                        }
                    </select>
                </div>
            </div>
            <div class="col-12 col-md-3 d-grid">
                <button class="btn btn-outline-secondary" @onclick="SearchBibleAsync">검색</button>
            </div>
        </div>
        @if (!string.IsNullOrWhiteSpace(bibleSearchMessage))
        {
            <small class="text-muted">@bibleSearchMessage</small>
        }
        @if (!string.IsNullOrWhiteSpace(bibleSearchResult))
        {
            <div class="alert alert-light mt-2 mb-0">
                <strong>@bibleSearchKey</strong> @bibleSearchResult
            </div>
        }
    </div>
    <textarea class="form-control" rows="2" @bind="newVerseText" placeholder="말씀을 입력하세요"></textarea>
    <div class="row g-2 align-items-center mt-2">
        <div class="col-12 col-md-5">
            <select class="form-select" @bind="newVerseType">
                @foreach (var purpose in purposes)
                {
                    <option value="@purpose">@purpose</option>
                }
            </select>
        </div>
        <div class="col-12 col-md-5">
            <input class="form-control" @bind="newPurpose" placeholder="말씀 용도 추가" />
        </div>
        <div class="col-12 col-md-2 d-grid">
            <button class="btn btn-outline-primary" @onclick="AddPurposeAsync">용도 추가</button>
        </div>
    </div>
    <div class="d-grid mt-3">
        <button class="btn btn-primary w-100" @onclick="AddVerseAsync">추가</button>
    </div>
    @if (!string.IsNullOrWhiteSpace(verseMessage))
    {
        <small class="@(verseMessageIsError ? "text-danger" : "text-muted")">@verseMessage</small>
    }
</div>

@if (!string.IsNullOrWhiteSpace(purposeMessage))
{
    <div class="mb-3">
        <small class="text-muted">@purposeMessage</small>
    </div>
}

<div class="d-flex flex-wrap gap-2 mb-3">
    <button class="btn btn-outline-danger" disabled="@(selectedVerseIds.Count == 0)" @onclick="DeleteSelectedAsync">선택 삭제</button>
    <button class="btn btn-outline-danger" disabled="@(verses.Count == 0)" @onclick="DeleteAllAsync">전체 삭제</button>
</div>

@if (verses.Count == 0)
{
    <p class="text-muted">등록된 말씀이 없습니다.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th class="text-center align-middle">
                    <div class="d-flex justify-content-center align-items-center">
                        <input class="md-checkbox" type="checkbox" @bind="IsAllSelected" />
                    </div>
                </th>
                <th class="text-center align-middle">말씀</th>
                <th class="text-center align-middle">유형</th>
                <th class="text-center align-middle">작업</th>
                <th class="text-center align-middle">말씀 ID</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var verse in verses)
            {
                <tr>
                    <td class="text-center align-middle">
                        <input class="md-checkbox" type="checkbox" checked="@selectedVerseIds.Contains(verse.Id)" @onchange="(e => ToggleVerseSelection(verse.Id, e))" />
                    </td>
                    <td style="min-width: 300px;">
                        <textarea class="form-control" rows="2" @bind="verse.Text"></textarea>
                    </td>
                    <td>
                        <select class="form-select" @bind="verse.Type">
                            @foreach (var purpose in purposes)
                            {
                                <option value="@purpose">@purpose</option>
                            }
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" @onclick="() => SaveVerseAsync(verse)">저장</button>
                        <button class="btn btn-sm btn-outline-danger ms-2" @onclick="() => DeleteVerseAsync(verse)">삭제</button>
                    </td>
                    <td class="text-muted">@verse.Id</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Verse> verses = new List<Verse>();
    private List<string> purposes = new List<string>();
    private string newVerseText = string.Empty;
    private string newVerseType = string.Empty;
    private string newPurpose = string.Empty;
    private string? purposeMessage;
    private string? verseMessage;
    private bool verseMessageIsError;
    private HashSet<Guid> selectedVerseIds = new HashSet<Guid>();
    private bool isAllSelected;
    private Dictionary<string, string> bibleEntries = new Dictionary<string, string>();
    private List<string> bibleBooks = new List<string>();
    private string? bibleBook;
    private string bibleChapter = string.Empty;
    private string bibleVerse = string.Empty;
    private string bibleBookOrder = "json";
    private readonly List<string> bibleKeyOrder = new List<string>();
    private readonly Dictionary<string, SortedDictionary<int, int>> bibleIndex = new();
    private List<string> bibleChapterOptions = new List<string>();
    private List<string> bibleVerseOptions = new List<string>();
    private string? bibleSearchMessage;
    private string? bibleSearchResult;
    private string? bibleSearchKey;

    protected override async Task OnInitializedAsync()
    {
        await LoadBibleAsync();
        await ReloadAsync();
    }

    private async Task AddVerseAsync()
    {
        verseMessage = null;
        verseMessageIsError = false;
        if (string.IsNullOrWhiteSpace(newVerseText) || string.IsNullOrWhiteSpace(newVerseType))
        {
            verseMessage = "말씀과 용도를 입력해 주세요.";
            verseMessageIsError = true;
            return;
        }

        var normalizedText = newVerseText.Trim();
        if (verses.Any(verse => string.Equals(verse.Text.Trim(), normalizedText, StringComparison.Ordinal)))
        {
            verseMessage = "이미 등록된 말씀입니다.";
            verseMessageIsError = true;
            return;
        }

        await DataStore.AddVerseAsync(newVerseText, newVerseType);
        verseMessage = "말씀을 추가했습니다.";
        newVerseText = string.Empty;
        await ReloadAsync();
    }

    private async Task SaveVerseAsync(Verse verse)
    {
        await DataStore.UpdateVerseAsync(verse.Id, verse.Text, verse.Type);
        await ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        verses = (await DataStore.GetVersesAsync()).ToList();
        purposes = (await DataStore.GetVersePurposesAsync()).ToList();
        if (purposes.Count > 0 && string.IsNullOrWhiteSpace(newVerseType))
        {
            newVerseType = purposes[0];
        }
        SyncSelection();
    }

    private async Task DeleteVerseAsync(Verse verse)
    {
        await DataStore.DeleteVerseAsync(verse.Id);
        await ReloadAsync();
    }

    private async Task AddPurposeAsync()
    {
        purposeMessage = null;
        if (string.IsNullOrWhiteSpace(newPurpose))
        {
            purposeMessage = "용도를 입력해 주세요.";
            return;
        }

        var added = await DataStore.AddVersePurposeAsync(newPurpose);
        purposeMessage = added ? "용도가 추가되었습니다." : "이미 존재하는 용도입니다.";
        newPurpose = string.Empty;
        await ReloadAsync();
    }

    private async Task DeleteSelectedAsync()
    {
        if (selectedVerseIds.Count == 0)
        {
            return;
        }

        await DataStore.DeleteVersesAsync(selectedVerseIds);
        await ReloadAsync();
    }

    private async Task DeleteAllAsync()
    {
        await DataStore.DeleteAllVersesAsync();
        await ReloadAsync();
    }

    private async Task LoadBibleAsync()
    {
        var biblePath = Path.Combine(WebHostEnvironment.ContentRootPath, "bible.json");
        if (!File.Exists(biblePath))
        {
            biblePath = Path.GetFullPath(Path.Combine(WebHostEnvironment.ContentRootPath, "..", "bible.json"));
        }

        if (!File.Exists(biblePath))
        {
            bibleSearchMessage = "bible.json 파일을 찾을 수 없습니다.";
            return;
        }

        try
        {
            var json = await File.ReadAllTextAsync(biblePath);
            bibleKeyOrder.Clear();
            using (var document = JsonDocument.Parse(json))
            {
                foreach (var item in document.RootElement.EnumerateObject())
                {
                    bibleKeyOrder.Add(item.Name);
                }
            }
            bibleEntries = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, string>>(json)
                ?? new Dictionary<string, string>();
            bibleIndex.Clear();
            foreach (var key in bibleEntries.Keys)
            {
                if (!TryParseReference(key, out var book, out var chapter, out var verse))
                {
                    continue;
                }

                if (!bibleIndex.TryGetValue(book, out var chapters))
                {
                    chapters = new SortedDictionary<int, int>();
                    bibleIndex[book] = chapters;
                }

                if (!chapters.TryGetValue(chapter, out var maxVerse) || verse > maxVerse)
                {
                    chapters[chapter] = verse;
                }
            }

            ApplyBibleBookOrder();
            UpdateChapterOptions();
        }
        catch (Exception ex)
        {
            bibleSearchMessage = $"성경 데이터를 불러오지 못했습니다: {ex.Message}";
        }
    }

    private void SearchBibleAsync()
    {
        bibleSearchMessage = null;
        bibleSearchResult = null;
        bibleSearchKey = null;

        if (bibleEntries.Count == 0)
        {
            bibleSearchMessage = "성경 데이터가 없습니다.";
            return;
        }

        if (string.IsNullOrWhiteSpace(bibleBook))
        {
            bibleSearchMessage = "성경 이름을 선택해 주세요.";
            return;
        }

        if (!int.TryParse(bibleChapter.Trim(), out var chapter) || chapter <= 0)
        {
            bibleSearchMessage = "장 번호를 확인해 주세요.";
            return;
        }

        if (!int.TryParse(bibleVerse.Trim(), out var verse) || verse <= 0)
        {
            bibleSearchMessage = "절 번호를 확인해 주세요.";
            return;
        }

        var key = $"{bibleBook}{chapter}:{verse}";
        if (!bibleEntries.TryGetValue(key, out var text))
        {
            bibleSearchMessage = "해당 구절을 찾을 수 없습니다.";
            return;
        }

        bibleSearchKey = key;
        bibleSearchResult = text;
        newVerseText = $"{bibleSearchKey} {bibleSearchResult}";
    }

    private void ToggleVerseSelection(Guid id, ChangeEventArgs args)
    {
        if (args.Value is bool isChecked && isChecked)
        {
            selectedVerseIds.Add(id);
        }
        else
        {
            selectedVerseIds.Remove(id);
        }

        isAllSelected = verses.Count > 0 && selectedVerseIds.Count == verses.Count;
    }

    private void SyncSelection()
    {
        selectedVerseIds = selectedVerseIds
            .Where(id => verses.Any(v => v.Id == id))
            .ToHashSet();
        isAllSelected = verses.Count > 0 && selectedVerseIds.Count == verses.Count;
    }

    private bool IsAllSelected
    {
        get => isAllSelected;
        set
        {
            isAllSelected = value;
            if (isAllSelected)
            {
                selectedVerseIds = verses.Select(v => v.Id).ToHashSet();
            }
            else
            {
                selectedVerseIds.Clear();
            }
        }
    }

    private static string ExtractBookName(string key)
    {
        if (string.IsNullOrWhiteSpace(key))
        {
            return string.Empty;
        }

        var index = 0;
        while (index < key.Length && !char.IsDigit(key[index]))
        {
            index++;
        }

        return index == 0 ? string.Empty : key[..index];
    }

    private static List<string> BuildBibleBookList(IEnumerable<string> keys, bool sortAlpha)
    {
        var books = new List<string>();
        var seen = new HashSet<string>(StringComparer.Ordinal);

        foreach (var key in keys)
        {
            var name = ExtractBookName(key);
            if (string.IsNullOrWhiteSpace(name) || !seen.Add(name))
            {
                continue;
            }

            books.Add(name);
        }

        if (sortAlpha)
        {
            books.Sort(StringComparer.Ordinal);
        }

        return books;
    }

    private void UpdateChapterOptions()
    {
        bibleChapterOptions.Clear();
        bibleVerseOptions.Clear();

        if (string.IsNullOrWhiteSpace(bibleBook) || !bibleIndex.TryGetValue(bibleBook, out var chapters))
        {
            bibleChapter = string.Empty;
            bibleVerse = string.Empty;
            return;
        }

        bibleChapterOptions = chapters.Keys.Select(value => value.ToString()).ToList();
        if (bibleChapterOptions.Count == 0)
        {
            bibleChapter = string.Empty;
            bibleVerse = string.Empty;
            return;
        }

        if (!bibleChapterOptions.Contains(bibleChapter))
        {
            bibleChapter = bibleChapterOptions[0];
        }

        UpdateVerseOptions();
    }

    private void UpdateVerseOptions()
    {
        bibleVerseOptions.Clear();

        if (string.IsNullOrWhiteSpace(bibleBook) || !bibleIndex.TryGetValue(bibleBook, out var chapters))
        {
            bibleVerse = string.Empty;
            return;
        }

        if (!int.TryParse(bibleChapter, out var chapter) || !chapters.TryGetValue(chapter, out var maxVerse))
        {
            bibleVerse = string.Empty;
            return;
        }

        bibleVerseOptions = Enumerable.Range(1, maxVerse)
            .Select(value => value.ToString())
            .ToList();

        if (bibleVerseOptions.Count == 0)
        {
            bibleVerse = string.Empty;
            return;
        }

        if (!bibleVerseOptions.Contains(bibleVerse))
        {
            bibleVerse = bibleVerseOptions[0];
        }
    }

    private void ApplyBibleBookOrder()
    {
        var useAlpha = string.Equals(bibleBookOrder, "alpha", StringComparison.Ordinal);
        var keys = bibleKeyOrder.Count > 0 ? bibleKeyOrder : bibleEntries.Keys;
        bibleBooks = BuildBibleBookList(keys, useAlpha);
        if (bibleBooks.Count == 0)
        {
            bibleBook = null;
            return;
        }

        if (string.IsNullOrWhiteSpace(bibleBook) || !bibleBooks.Contains(bibleBook))
        {
            bibleBook = bibleBooks[0];
        }
    }

    private static bool TryParseReference(string key, out string book, out int chapter, out int verse)
    {
        book = string.Empty;
        chapter = 0;
        verse = 0;

        if (string.IsNullOrWhiteSpace(key))
        {
            return false;
        }

        var trimmed = key.Trim();
        var index = 0;
        while (index < trimmed.Length && !char.IsDigit(trimmed[index]))
        {
            index++;
        }

        if (index == 0 || index >= trimmed.Length)
        {
            return false;
        }

        var rest = trimmed[index..];
        var colonIndex = rest.IndexOf(':');
        if (colonIndex <= 0 || colonIndex >= rest.Length - 1)
        {
            return false;
        }

        if (!int.TryParse(rest[..colonIndex], out chapter) || !int.TryParse(rest[(colonIndex + 1)..], out verse))
        {
            return false;
        }

        book = trimmed[..index];
        return chapter > 0 && verse > 0;
    }

    private string? BibleBook
    {
        get => bibleBook;
        set
        {
            if (bibleBook == value)
            {
                return;
            }

            bibleBook = value;
            UpdateChapterOptions();
        }
    }

    private string BibleChapter
    {
        get => bibleChapter;
        set
        {
            if (bibleChapter == value)
            {
                return;
            }

            bibleChapter = value ?? string.Empty;
            UpdateVerseOptions();
        }
    }

    private string BibleVerse
    {
        get => bibleVerse;
        set => bibleVerse = value ?? string.Empty;
    }

    private string BibleBookOrder
    {
        get => bibleBookOrder;
        set
        {
            if (bibleBookOrder == value)
            {
                return;
            }

            bibleBookOrder = value ?? "json";
            ApplyBibleBookOrder();
            UpdateChapterOptions();
        }
    }
}
