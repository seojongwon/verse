@page "/admin/use-qr"
@attribute [Authorize]
@using RetreatVerses.App.Data
@inject IDataStore DataStore
@inject NavigationManager NavigationManager

<h3>사용용 QR 코드 생성</h3>

<p class="text-muted">유형을 선택하면 해당 사용 페이지로 이동하는 QR 코드를 생성합니다.</p>

<div class="row g-3">
    <div class="col-md-6">
        <label class="form-label">사용 유형 선택</label>
        <select class="form-select" @bind="SelectedPurpose">
            <option value="">유형을 선택하세요</option>
            @foreach (var purpose in purposes)
            {
                <option value="@purpose">@purpose</option>
            }
        </select>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(qrUrl))
{
    <div class="mt-4">
        <label class="form-label">사용 링크</label>
        <input class="form-control" readonly value="@qrUrl" />
        <div class="d-flex flex-wrap gap-2 mt-2">
            <a class="btn btn-outline-secondary" href="@qrUrl" target="_blank" rel="noopener">링크 열기</a>
            <small class="text-muted d-flex align-items-center">QR 코드로 바로 접속할 수 있습니다.</small>
        </div>
    </div>
}

@if (!string.IsNullOrWhiteSpace(qrCodeDataUrl))
{
    <div class="mt-3 d-flex flex-wrap gap-3 align-items-start">
        <div class="p-2 border rounded bg-light">
            <img src="@qrCodeDataUrl" alt="말씀 사용 QR 코드" style="max-width: 200px; height: auto;" />
        </div>
        <div class="d-flex flex-column gap-2">
            <a class="btn btn-outline-primary" href="@qrCodeDataUrl" download="@qrFileName">QR 다운로드</a>
        </div>
    </div>
}

@code {
    private List<string> purposes = new List<string>();
    private string? selectedPurpose;
    private string? qrUrl;
    private string? qrCodeDataUrl;
    private string qrFileName = "use-qr.png";

    protected override async Task OnInitializedAsync()
    {
        purposes = (await DataStore.GetVersePurposesAsync()).ToList();
    }

    private string? SelectedPurpose
    {
        get => selectedPurpose;
        set
        {
            selectedPurpose = value;
            BuildQrAssets();
        }
    }

    private void BuildQrAssets()
    {
        qrUrl = BuildQrUrl();
        if (string.IsNullOrWhiteSpace(qrUrl))
        {
            qrCodeDataUrl = null;
            return;
        }

        using var generator = new QRCoder.QRCodeGenerator();
        using var data = generator.CreateQrCode(qrUrl, QRCoder.QRCodeGenerator.ECCLevel.Q);
        var png = new QRCoder.PngByteQRCode(data);
        var bytes = png.GetGraphic(20);
        qrCodeDataUrl = $"data:image/png;base64,{Convert.ToBase64String(bytes)}";
        qrFileName = $"use-qr-{SanitizeFileName(selectedPurpose)}.png";
    }

    private string? BuildQrUrl()
    {
        if (string.IsNullOrWhiteSpace(selectedPurpose))
        {
            return null;
        }

        var encoded = Uri.EscapeDataString(selectedPurpose.Trim());
        var baseUri = NavigationManager.BaseUri.TrimEnd('/');
        return $"{baseUri}/use/{encoded}";
    }

    private static string SanitizeFileName(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return "purpose";
        }

        var cleaned = new string(value.Trim().Select(c => char.IsLetterOrDigit(c) ? c : '-').ToArray());
        return string.IsNullOrWhiteSpace(cleaned) ? "purpose" : cleaned.ToLowerInvariant();
    }
}
